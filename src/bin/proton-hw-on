#!/bin/bash

# Enable hardware-accelerated GPU scheduling for Proton games
# This sets the Windows registry key HwSchMode to 2 (enabled)

# Get the directory where this script is located
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

# log_file="/tmp/proton-hw-on.log"
log () {
    # echo "$(date +'%Y-%m-%d %H:%M:%S') $1" | tee -a "$log_file"
    systemd-cat -t "proton-hw" -p info <<< "$1"
}

set -e  # Exit on any error

log "Enabling hardware-accelerated GPU scheduling"

# Use proton-wine-exec to set the registry key
if "${SCRIPT_DIR}/proton-wine-exec" "C:\\windows\\system32\\reg.exe" ADD \
   "HKLM\\System\\CurrentControlSet\\Control\\GraphicsDrivers" \
   /v "HwSchMode" /t "REG_DWORD" /d "2" /f; then
    log "Successfully enabled hardware-accelerated GPU scheduling"
else
    log "Warning: Failed to set registry key for hardware GPU scheduling"
fi

# Execute the original command
exec "$@"
